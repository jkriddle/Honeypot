@{
    ViewBag.Title = "ScheduleRide";
    Layout = "~/Views/Shared/_DashboardLayout.cshtml";
}

<div class="contentWrapper">

<div id="pageHeader">
    <h2>Schedule Ride</h2>
</div>

<br />
<span id="fixedHeaderAdjustment"></span>

<div id="rideFormWrapper" data-tripInfo="">
    <ul id="stepNav">
        <li class="pickup active">Pickup</li>
        <li class="addresses">Destination</li>
        <li class="confirmation">Confirmation</li>
    </ul>
    <hr id="stepLine" />
    <h5 id="status"></h5>
    <form id="rideForm" method="post" action="@Url.Action("Create", "Trip", null)" class="bbq">
        <div id="fieldWrapper">
            
            <div class="step pickup" id="pickup" data-address="">
                <!-- STEP 2 -->
                <div class="destination" data-address="">
                    <div class="blockTitle"><h3>Pickup</h3> </div>
                    <div class="destinationInner">
                        <h3>When do you need a ride?</h3>
                        <label class="tripTypeField">
                             <input type="radio" name="tripType" value="NOW" class="tripTypeRadio" style="background-color:transparent; filter:none; border:none"><div>NOW</div>
                            
                         </label>
                         <label class="tripTypeField">
                            <input type="radio" name="tripType" value="LATER" class="tripTypeRadio" style="background-color:transparent; filter:none; border:none"><div>LATER</div>
                         </label>                                                       
                        <div class="clear"></div>

                        <fieldset class="pickupTimeField">
                            <label for="pickupTime">Pickup Time</label>
                            <input type="text" name="pickupTime" class="pickupTime timePicker"  />
                        </fieldset>
                        <fieldset class="pickupDateField">
                            <label for="pickupDate">Date</label>
                            <input type="text" name="pickupDate" class="pickupDate datepicker" />
                        </fieldset>
                        <fieldset class="bidWindowTimeField">
                            <label for="pickupTime">Bid Window Time</label>
                            <input type="text" name="bidWindowTime" class="bidWindowTime timePicker"  />
                        </fieldset>
                        <fieldset class="bidWindowDateField">
                            <label for="pickupDate">Bid Window Date</label>
                            <input type="text" name="bidWindowDate" class="bidWindowDate datepicker" />
                        </fieldset>
                        <fieldset>
                            <label for="address">Address</label>
                            <textarea type="text" name="address" rows="10" class="address" ></textarea>
                        </fieldset>
                        
                        <fieldset>
                            <label for="notes">Notes for Driver</label>
                            <textarea  name="notes" class="notes" ></textarea>
                        </fieldset>
                        
                        <div class="addressSelection" >
                            <p>We found a few different matching addresses. Select the correct one from the list below:</p>
                        </div>
                        <input type="hidden" name="lat" class="lat"/>
                        <input type="hidden" name="lng" class="lng"/>
                    </div>
                </div>
            </div>
            <div id="addresses" class="step destinations">
                <!-- STEP 3 - DESTINATIONS -->
                <div class="destination dest1" data-address="">
                    <div class="blockTitle up"><a href="#" class="toggleDest"><img src="/Content/img/arrow_up.png" /></a><h3>Destination 1</h3><a href="#" class="addDestination">+</a></div>
                    <div class="destinationInner">
                        <fieldset>
                            <label for="address">Address</label>
                            <textarea type="text" name="address" rows="40" class="address" ></textarea>
                        </fieldset>
                        <fieldset>
                            <label for="duration">Duration: <span>0 hrs</span></label>
                            <div class="durationSlider"></div>
                            <input type="hidden" name="duration" class="duration" />
                        </fieldset>
                        <fieldset>
                            <label for="notes">Notes for Driver</label>
                            <textarea  name="notes" class="notes" ></textarea>
                        </fieldset>
                        <div class="addressSelection" >
                            <p>We found a few different matching addresses. Select the correct one from the list below:</p>
                        </div>
                        <input type="hidden" name="lat" class="lat"/>
                        <input type="hidden" name="lng" class="lng"/>
                    </div>		
                </div>
            </div>

            <div id="confirmation" class="step">
                <!-- STEP 3 - DESTINATIONS -->
                <div class="destination">
                    <div class="blockTitle up"><a href="#" class="toggleDest"><img src="/Content/img/arrow_up.png" /></a><h3>Destination 1</h3><a href="#" class="addDestination">+</a></div>
                    <h5>Confirm your trip details:</h5>
                    <div id="confirmationAddressContainer"></div>
                    <div id="mapCanvas" width="595px" height="400px"></div>
                </div>    
            </div>
            

        </div>
        <div id="formNavigation">
            <input type="button" id="record" style="display:none;" value="Confirm Trip"/>
            <input  id="next" value="Next" type="button" />
           <!-- <input class="navigation_button" id="next" value="Next" type="submit" />-->				
            <input class="navigation_button" id="back" value="Back" type="reset" />
        </div>
        
        <input type="hidden" id="formStatus" value=""/>
    </form>
    <p id="data"></p>
</div>


<div id="destinationTemplate" style="display:none">
    <div class="blockTitle up"><a href="#" class="toggleDest"><img src="/Content/img/arrow_up.png" /></a><h3>Destination <span></span></h3>  <a href="#" class="addDestination">+</a><a href="#" class="removeDestination">x</a></div>
    <div class="destinationInner">
        <fieldset>
            <label for="address">Address</label>
            <textarea type="text" name="address" rows="40" class="address" ></textarea>
        </fieldset>
        <fieldset>
            <label for="duration">Duration: <span>0 hrs</span></label>
            <div class="durationSlider"></div>
            <input type="hidden" name="duration" class="duration" />
        </fieldset>
        <fieldset>
            <label for="notes">Notes for Driver</label>
            <textarea  name="notes" class="notes" ></textarea>
        </fieldset>
        <div class="addressSelection" >
            <p>We found a few different matching addresses. Select the correct one from the list below:</p>
        </div>
        <input type="hidden" name="lat" class="lat"/>
        <input type="hidden" name="lng" class="lng"/>
    </div>		
</div>


<div id="confirmationAddressTemplate" style="display:none">
    <h5></h5>
    <p></p>
</div>

</div>

    
<script type="text/javascript">

    $(function () {

        var destNum = 1;
        var ride = new ScheduleRide();

        // Setup interface
        $(".durationSlider").slider({
            value: 0,
            min: 0,
            max: 5,
            step: .5,
            slide: function (event, ui) {
                $(this).parent().children("input.duration").val(ui.value);
                $(this).parent().children("label").children("span").text(ui.value + " hrs");
                // $("#amount").val("$" + ui.value);
            }
        });

        $(".datepicker").datepicker();
        $(".timePicker").timepicker({});

        // Confirm address after entry.
        $('.address').live('blur', function () {
            var formStep = $("#rideForm").formwizard("state");
            var formStepId = "#" + formStep.currentStep;
            ride.checkAddress($(formStepId));
        });

        // Go to next panel
        $("#next").click(function (e) {
            var formStep = $("#rideForm").formwizard("state");

            if (formStep.currentStep == "addresses") {
                ride.createConfirmation();
            }

            $("#rideForm").formwizard("next");

            e.preventDefault();
        });

        // Show previous panel
        $("#back").click(function (e) {
            e.preventDefault();
            $('#next').show();
            $('#record').hide();
        });

        $('.addressSelection a').live('click', function (e) {
            var currClass = $(this).attr("class");
            var classArr = currClass.split('-');
            var arrNum = classArr[1];
            var addressData = $(this).parent().data('addressOptions');
            var addInfo = addressData[arrNum];
            var currFieldBlock = $(this).parent().parent();
           // $(currFieldBlock).parent().data("address", addInfo);
            $(currFieldBlock).parent().children('.blockTitle').css("background-color", "#A0D063");
            ride.replaceAddress(currFieldBlock, addInfo);

            var formStep = $("#rideForm").formwizard("state");
            var formStepId = "#" + formStep.currentStep;
            ride.checkAddress($(formStepId));
            
            $(this).parent().hide();
            e.preventDefault();
        });


        // Select Now or Later
        $('.tripTypeField').click(function () {
            var el = $(this);
            $(el).attr("checked", "checked");
            var tripType = $('input[type="radio"]', el).val();

            if (tripType == "NOW") {
                $('.pickupDateField').hide();
                $('.pickupTimeField').hide();
                $('.bidWindowDateField').hide();
                $('.bidWindowTimeField').hide();
                ride.IsImmediate = true;
            } else {
                $('.pickupDateField').show();
                $('.pickupTimeField').show();
                $('.bidWindowDateField').show();
                $('.bidWindowTimeField').show();
                ride.IsImmediate = false;
            }
        });

        // Confirm trip
        $("#record").click(function (e) {
            ride.sendJSON();
            e.preventDefault();
        });

        // Add a trip destination
        $('.addDestination').live('click', function (e) {
            $(this).parent().siblings('.destinationInner').slideToggle();
            destNum++;
            $("#destinationTemplate .blockTitle h3 span").html(destNum);
            var destTemplate = $("#destinationTemplate").html();
            $('#addresses').append('<div class="destination dest' + destNum + '"></div>');
            $('.dest' + destNum).append(destTemplate);
        });


        $("#rideForm").bind("step_shown", function (event, data) {
            var state = $("#rideForm").formwizard("state");
            var cs = state.currentStep;
            $("#stepNav li").each(function () {
                $(this).removeClass('active');
                if ($(this).hasClass(cs)) {
                    $(this).addClass('active');
                }
            });

            // Show map of trip
            if (cs == "confirmation") {
                $("#mapCanvas").show();
                ride.resetMap();
            }

        });

        /* SWITCHING ARROW WHEN TOGGLING SLIDE */
        /* TODO: FIGURE OUT MORE ELEGANT WAY TO DO THIS */
        function switchArrow(item) {
            if ($(item).parent().hasClass('up')) {
                $(item).parent().removeClass('up').addClass('down');
                $(item).children('img').attr("src", "/Content/img/arrow_down.png")
            } else if ($(item).parent().hasClass('down')) {
                $(item).parent().removeClass('down').addClass('up');
                $(item).children('img').attr("src", "/Content/img/arrow_up.png")
            }
        }

        // Hide/expand destinations
        $('.toggleDest').live('click', function (e) {
            //switchArrow($(this));
            $(this).parent().siblings('.destinationInner').slideToggle();
            e.preventDefault();
        });

        // setup form wizard
        $("#rideForm").formwizard({
            formPluginEnabled: true,
            validationEnabled: true,
            focusFirstInput: true,
            formOptions: {
                success: function (data) {
                    $("#status").fadeTo(500, 1, function () {
                        $(this).html("You are now registered!").fadeTo(5000, 0);
                    });
                },
                dataType: 'json',
                resetForm: true
            }
        });

    });
</script>
<script type="text/javascript"  src="http://maps.googleapis.com/maps/api/js?key=AIzaSyC9NH77png3ByfyA-Tqzpaew3owW-8bOe4&sensor=false"></script>